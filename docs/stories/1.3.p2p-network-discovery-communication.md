# Story 1.3: P2P Network Discovery & Communication

## Status
ðŸ“‹ **Draft** - Ready for Development

## Story
**As a distributed AI node,**
**I want to discover and connect with other nodes in the network,**
**so that I can participate in collective learning and knowledge sharing.**

## Acceptance Criteria
1. libcluster configured for automatic node discovery and clustering
2. GenServer-based node management with supervision trees for fault tolerance
3. Phoenix Channels implemented for real-time node-to-node messaging
4. Basic node status tracking (online, offline, connecting) across the network
5. Connection health monitoring and automatic reconnection logic
6. Network topology tracking showing which nodes are connected to which
7. Support for 3-5 concurrent nodes with stable connections

## Tasks / Subtasks
- [ ] Configure libcluster for automatic node discovery (AC: 1)
  - [ ] Add libcluster dependency to xpando_node app
  - [ ] Configure Gossip strategy for local network discovery
  - [ ] Set up EPMD configuration for distributed Elixir
  - [ ] Test cluster formation with 2+ nodes
- [ ] Implement GenServer-based node management system (AC: 2, 4)
  - [ ] Create XPando.Node.Manager GenServer in apps/xpando_node/lib/xpando_node/
  - [ ] Add supervision tree for fault tolerance and restart strategies
  - [ ] Implement node status tracking (online/offline/connecting states)
  - [ ] Create periodic heartbeat system for health monitoring
- [ ] Implement Phoenix Channels for real-time messaging (AC: 3)
  - [ ] Create NodeChannel in apps/xpando_web/lib/xpando_web_web/channels/
  - [ ] Configure Phoenix.PubSub for inter-node message broadcasting
  - [ ] Implement basic message types (join, leave, heartbeat, data)
  - [ ] Add channel authentication using existing User/Token system
- [ ] Build connection health monitoring and reconnection logic (AC: 5)
  - [ ] Create periodic connection health checks in NodeManager
  - [ ] Implement automatic reconnection with exponential backoff
  - [ ] Add connection timeout handling and error recovery
  - [ ] Log connection events for debugging and monitoring
- [ ] Implement network topology tracking (AC: 6)
  - [ ] Create network state tracking in NodeManager
  - [ ] Track which nodes are connected to which other nodes
  - [ ] Implement topology update propagation via PubSub
  - [ ] Store topology state for dashboard display
- [ ] Add comprehensive testing for P2P functionality (AC: 7)
  - [ ] Unit tests for NodeManager GenServer
  - [ ] Integration tests for Phoenix Channels messaging
  - [ ] End-to-end tests for multi-node cluster formation
  - [ ] Load testing for 3-5 concurrent node connections

## Dev Notes

### Previous Story Insights
From Story 1.2 completion:
- Authentication system is fully functional with User/Token resources and cryptographic node identity
- Node resource exists at `apps/xpando_core/lib/xpando/core/node.ex` with authorization policies
- Phoenix web app structure is established in `apps/xpando_web/`
- All tests are passing (73 tests, 0 failures) with proper security validation

### Distributed Systems Architecture
From [Source: architecture/tech-stack.md]:
- **Backend Language**: Elixir 1.18.1 with built-in distributed computing and fault tolerance
- **Backend Framework**: Phoenix 1.8.0 with Phoenix.PubSub for inter-node communication
- **Monitoring**: Telemetry + Prometheus for metrics collection and observability

### P2P Architecture Context
From [Source: architecture/backend-architecture.md]:
- **P2P Implementation Location**: `apps/xpando_core/lib/xpando/p2p/` directory structure
  - `node_manager.ex` - Node lifecycle management
  - `discovery.ex` - libcluster integration for node discovery  
  - `protocol.ex` - P2P protocol implementation
- **Critical Rule**: Use Phoenix.PubSub for all inter-node communication, no direct GenServer calls
- **Supervision**: All P2P components must use proper OTP supervision trees

### File Locations and Project Structure
From [Source: architecture/unified-project-structure.md]:
- **P2P Node Implementation**: `apps/xpando_node/` umbrella application
  - `lib/xpando_node/manager.ex` - Main node management GenServer
  - `lib/xpando_node/discovery.ex` - Node discovery implementation
  - `lib/xpando_node/protocol.ex` - P2P protocol handlers
- **Phoenix Channels**: `apps/xpando_web/lib/xpando_web_web/channels/`
  - `node_channel.ex` - Real-time node-to-node messaging channel
- **Channel Router**: Update `apps/xpando_web/lib/xpando_web_web/channels/user_socket.ex`

### Node Data Model Extensions
From [Source: architecture/data-models.md] and existing Node resource:
- **Existing Node Attributes**: id, name, status (online/offline/syncing), specializations, reputation_score, last_heartbeat
- **Status Tracking**: Node.status enum already supports network states
- **Heartbeat System**: last_heartbeat timestamp field exists for connection monitoring
- **Network Relationships**: Node has relationships with Knowledge and Contribution resources

### Coding Standards for P2P Implementation
From [Source: architecture/coding-standards.md]:
- **P2P Protocol**: Use Phoenix.PubSub for all inter-node communication, no direct GenServer calls
- **Critical Rule**: All P2P components require proper OTP supervision trees for fault tolerance
- **PubSub Topics**: Use colon-separated naming convention (`"network:updates"`, `"node:heartbeat"`)
- **Error Boundaries**: Implement proper error handling and recovery for network failures

### Testing Requirements
From [Source: architecture/testing-strategy.md]:
- **Test Location**: `apps/xpando_node/test/xpando_node/` and `apps/xpando_web/test/xpando_web/channels/`
- **Test Framework**: ExUnit with proper distributed testing support
- **Test Types Required**:
  - Unit tests for GenServer behavior (70% of tests)
  - Integration tests for Phoenix Channels (25% of tests)
  - E2E tests for multi-node clustering (5% of tests)
- **Distributed Testing**: Use ExUnit.start() with distributed node configuration

### Technical Implementation Details
From [Source: architecture/backend-architecture.md]:

**libcluster Configuration Pattern:**
```elixir
# In config/config.exs
config :libcluster,
  topologies: [
    gossip_example: [
      strategy: Cluster.Strategy.Gossip,
      config: [
        port: 45892,
        if_addr: "0.0.0.0",
        multicast_addr: "230.1.1.251",
        multicast_ttl: 1
      ]
    ]
  ]
```

**GenServer Template for NodeManager:**
```elixir
defmodule XPando.Node.Manager do
  use GenServer
  require Logger
  
  def start_link(opts) do
    GenServer.start_link(__MODULE__, opts, name: __MODULE__)
  end
  
  def init(_opts) do
    {:ok, %{nodes: %{}, topology: %{}}, {:continue, :connect_cluster}}
  end
  
  def handle_continue(:connect_cluster, state) do
    # libcluster connection logic
    {:noreply, state}
  end
end
```

### Database Schema Extensions
From [Source: architecture/database-schema.md]:
- **Existing Node table** has required fields for P2P functionality:
  - status field supports network states
  - last_heartbeat for connection monitoring
  - metadata JSONB field for storing P2P connection info
- **Network Events table** exists for audit logging:
  - event_type, node_id, payload fields suitable for P2P events

### Authentication Integration
From Story 1.2 context:
- **Channel Authentication**: Use existing ash_authentication Token system for channel authentication
- **Node Identity**: Leverage existing cryptographic node identity system for secure P2P authentication
- **Authorization Policies**: Channel access controlled by existing User role system (user/node_operator/admin)

### Testing Standards
- **Test File Locations**: 
  - `apps/xpando_node/test/xpando_node/manager_test.exs`
  - `apps/xpando_web/test/xpando_web_web/channels/node_channel_test.exs`
- **Testing Patterns**: Use ExUnit with DataCase support and proper fixtures
- **Distributed Testing**: Configure multiple test nodes for cluster formation testing
- **Channel Testing**: Use Phoenix.ChannelTest for real-time messaging validation

### Technical Constraints
From [Source: architecture/tech-stack.md]:
- **Elixir Version**: 1.18.1 required for distributed computing features
- **Phoenix Version**: 1.8.0+ with Phoenix.PubSub integration
- **Network Support**: Must handle 3-5 concurrent node connections efficiently
- **Fault Tolerance**: All P2P components must recover gracefully from network failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation with complete architecture context and small digestible tasks | Bob (SM) |