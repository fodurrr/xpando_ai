# Story 1.2: Authentication & Node Identity Management

## Status
Draft

## Story
**As a node operator,**
**I want secure authentication and identity management for my AI node,**
**so that I can participate in the network with verified identity and appropriate permissions.**

## Acceptance Criteria
1. ash_authentication configured with node registration and login capabilities
2. Node identity system supporting unique node IDs and cryptographic key pairs
3. Basic user authentication for web dashboard access
4. Permission system distinguishing node operators from regular users
5. Session management and secure token handling implemented
6. Node identity verification preventing duplicate or malicious registrations
7. Authentication policies integrated with all Ash Resources

## Tasks / Subtasks
- [ ] Configure ash_authentication framework integration (AC: 1)
  - [ ] Add AshAuthentication extension to existing User resource or create new one
  - [ ] Configure token generation with signing secret
  - [ ] Set up AshAuthentication.Supervisor in application supervisor tree
  - [ ] Add required PostgreSQL extensions (ash-functions, citext)
- [ ] Create Token resource for authentication (AC: 1, 5)
  - [ ] Create XPando.Core.Token resource extending AshAuthentication.TokenResource
  - [ ] Configure postgres data layer for tokens table
  - [ ] Add authentication policies to Token resource
- [ ] Implement User resource with authentication strategies (AC: 3, 4)
  - [ ] Create XPando.Core.User resource with AshAuthentication extension
  - [ ] Add email/password authentication strategy
  - [ ] Configure user roles (user, node_operator, admin)
  - [ ] Add relationship between User and Node resources
- [ ] Implement node identity system (AC: 2, 6)
  - [ ] Add cryptographic key pair generation to Node resource
  - [ ] Implement unique node ID system with validation
  - [ ] Add node identity verification methods
  - [ ] Create node registration action with identity checks
- [ ] Configure session management (AC: 5)
  - [ ] Set up secure token handling with proper expiration
  - [ ] Configure session storage and cleanup
  - [ ] Implement token refresh mechanism
  - [ ] Add logout and session invalidation
- [ ] Integrate authentication policies with all resources (AC: 7)
  - [ ] Add Ash.Policy.Authorizer to Node resource
  - [ ] Add Ash.Policy.Authorizer to Knowledge resource  
  - [ ] Add Ash.Policy.Authorizer to Contribution resource
  - [ ] Define role-based policies for each resource
- [ ] Create authentication middleware and plugs (AC: 3, 4)
  - [ ] Create Phoenix authentication plug for web dashboard
  - [ ] Add role verification middleware
  - [ ] Configure authentication context in Phoenix router
- [ ] Add comprehensive testing (AC: 1-7)
  - [ ] Unit tests for User and Token resources
  - [ ] Integration tests for authentication flow
  - [ ] Security tests for authorization policies
  - [ ] E2E tests for login/logout functionality

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Modern Ash 3.5+ uses `Ash.Domain` - XPando.Core domain already exists
- ash_authentication 4.9.9 is already added as dependency
- Core domain models defined: Node, Knowledge, Contribution entities
- Database configured with ash_postgres adapter and migrations working
- All tests passing with comprehensive test infrastructure in place

### Authentication Framework Configuration
From [Source: architecture/tech-stack.md]:
- **Authentication Framework**: ash_authentication 4.9.9 for user and node authentication with integrated auth and policy enforcement
- **Database**: PostgreSQL 16+ with ACID compliance
- **Backend Language**: Elixir 1.18.1 with Phoenix + Ash 1.8.0 / 3.5.36

### Data Models and Schema
From [Source: architecture/data-models.md] and [Source: architecture/database-schema.md]:

**User Resource Structure:**
- id: UUID - Primary key
- email: String - Unique email for authentication
- hashed_password: String - Secure password storage
- role: String - User role (user, node_operator, admin)
- node_id: UUID - Reference to associated Node
- confirmed_at: DateTime - Email confirmation timestamp

**Node Identity Extensions:**
- Existing Node resource at `apps/xpando_core/lib/xpando/core/node.ex`
- Add cryptographic key pairs for node identity
- Add unique node ID validation system
- Relationship with User resource for authentication

### File Locations and Project Structure
From [Source: architecture/unified-project-structure.md]:
- **User Resource**: `apps/xpando_core/lib/xpando/core/user.ex`
- **Token Resource**: `apps/xpando_core/lib/xpando/core/token.ex`  
- **Authentication Domain**: Update `apps/xpando_core/lib/xpando/core.ex`
- **Web Authentication**: `apps/xpando_web/lib/xpando_web_web/plugs/`
- **Migrations**: `apps/xpando_core/priv/repo/migrations/`

### Backend Architecture Requirements
From [Source: architecture/backend-architecture.md]:

**Ash Resource Template Pattern:**
```elixir
defmodule XPando.Core.User do
  use Ash.Resource,
    domain: XPando.Core,
    data_layer: AshPostgres.DataLayer,
    extensions: [AshAuthentication],
    authorizers: [Ash.Policy.Authorizer]
```

**Authentication Policies Structure:**
- Use Ash.Policy.Authorizer for all resources
- Implement role-based authorization (user, node_operator, admin)
- AshAuthentication.Checks.AshAuthenticationInteraction bypass for auth actions
- Policy structure with authorize_if and forbid_if conditions

### Database Extensions Required
From ash_authentication documentation:
- PostgreSQL extensions: "ash-functions", "citext"
- Add to XPando.Repo.installed_extensions/0

### Security Requirements  
From [Source: architecture/coding-standards.md]:
- **Migration Safety**: Never modify Ash-generated migrations directly, use Ash migrations
- **Error Boundaries**: Every LiveView must implement handle_error callbacks
- Secure session handling and token management
- Input validation and sanitization

### Testing Requirements
From [Source: architecture/testing-strategy.md]:
- **Test Location**: `apps/xpando_core/test/xpando/core/`
- **Test Framework**: ExUnit with DataCase support
- **Test Types Required**:
  - Unit tests for User/Token resources (70% of tests)
  - Integration tests for auth flow (25% of tests)
  - E2E tests for login/registration (5% of tests)
- **Testing Pattern**: Use fixtures and factory functions
- **Security Testing**: Validate authorization policies and token security

### Technical Constraints
From [Source: architecture/tech-stack.md]:
- Elixir 1.18.1 and Phoenix 1.8.0+ required
- ash_authentication 4.9.9 integration
- PostgreSQL 16+ with proper indexing
- Session security with CSRF protection and secure cookies

## QA Results

### Review Date: 2025-08-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**CRITICAL BLOCKING ISSUES IDENTIFIED**

This story is currently in Draft status with no implementation present. A comprehensive authentication and identity management system requires:

1. **Missing Core Implementation**: No User or Token resources exist
2. **No Authentication Strategy**: ash_authentication configuration not implemented  
3. **Zero Test Coverage**: No security testing for critical authentication features
4. **Incomplete Architecture**: Node identity system integration missing

### Refactoring Performed

**None** - No implementation exists to refactor. All work must be completed from scratch.

### Compliance Check

- Coding Standards: **❌ FAIL** - No implementation to assess
- Project Structure: **✓ PASS** - Documentation follows established patterns  
- Testing Strategy: **❌ FAIL** - No tests exist for critical security features
- All ACs Met: **❌ FAIL** - Zero acceptance criteria implemented

### Requirements Traceability Analysis

**All 7 Acceptance Criteria have ZERO test coverage:**

1. **AC1**: ash_authentication configuration - **❌ NO IMPLEMENTATION**
   - Missing: User resource with AshAuthentication extension
   - Missing: Token resource configuration
   - Missing: AshAuthentication.Supervisor setup

2. **AC2**: Node identity system - **❌ NO IMPLEMENTATION**  
   - Missing: Cryptographic key pair generation
   - Missing: Unique node ID validation
   - Missing: Identity verification methods

3. **AC3**: Basic user authentication - **❌ NO IMPLEMENTATION**
   - Missing: Password authentication strategy
   - Missing: Web dashboard authentication

4. **AC4**: Permission system - **❌ NO IMPLEMENTATION**
   - Missing: User roles (user, node_operator, admin)
   - Missing: Authorization policies

5. **AC5**: Session management - **❌ NO IMPLEMENTATION**
   - Missing: Secure token handling
   - Missing: Session storage and cleanup

6. **AC6**: Node identity verification - **❌ NO IMPLEMENTATION**
   - Missing: Duplicate prevention logic
   - Missing: Malicious registration checks

7. **AC7**: Authentication policies - **❌ NO IMPLEMENTATION**
   - Missing: Ash.Policy.Authorizer integration
   - Missing: Resource-level authorization

### Security Review

**CRITICAL SECURITY GAPS IDENTIFIED:**

- **Authentication**: No authentication mechanism exists
- **Authorization**: No access control implemented  
- **Session Security**: No secure session management
- **Identity Verification**: No cryptographic identity system
- **Input Validation**: No security validation present

**Security Risk Level**: **CRITICAL** - System completely vulnerable

### Performance Considerations

Cannot assess performance without implementation. Performance testing must include:
- Authentication endpoint response times
- Session lookup performance
- Cryptographic operations efficiency

### Non-Functional Requirements Assessment

**All NFRs FAIL due to missing implementation:**

- **Security**: FAIL - No authentication/authorization exists
- **Performance**: FAIL - Cannot measure without implementation  
- **Reliability**: FAIL - No error handling or recovery mechanisms
- **Maintainability**: CONCERNS - Good documentation but requires implementation

### Files Modified During Review

**None** - Review only, no implementation changes made.

### Implementation Roadmap (Critical Path)

**Phase 1: Core Authentication (Must Complete First)**
1. Add PostgreSQL extensions to XPando.Repo
2. Create Token resource with AshAuthentication.TokenResource
3. Create User resource with password authentication strategy
4. Configure AshAuthentication.Supervisor

**Phase 2: Node Identity Integration**  
1. Extend Node resource with User relationship
2. Add cryptographic key pair generation
3. Implement node registration with identity verification

**Phase 3: Authorization & Security**
1. Add Ash.Policy.Authorizer to all resources
2. Implement role-based access control
3. Configure session security and CSRF protection

**Phase 4: Comprehensive Testing**
1. Unit tests for User/Token resources (15+ test cases)
2. Integration tests for authentication flow (8+ scenarios)
3. Security tests for authorization policies (10+ test cases)
4. E2E tests for login/registration (5+ flows)

### Gate Status

Gate: **FAIL** → docs/qa/gates/1.2-authentication-node-identity.yml

**Blocking Conditions:**
- No implementation exists
- Zero test coverage for security-critical features
- Story status is Draft (should be Review for QA)

### Recommended Status

**❌ Implementation Required - Return to Development**

**Cannot proceed until:**
1. Complete core authentication implementation
2. Add comprehensive security testing  
3. Change story status to "Review"
4. Implement all 7 acceptance criteria

**Estimated Work Required:** 15-20 hours of development + testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation with complete architecture context | Bob (SM) |
| 2025-08-28 | 1.1 | QA Review - FAIL due to missing implementation | Quinn (Test Architect) |