# Test Design: Story 1.3

Date: 2025-08-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 8 (44%)
- Integration tests: 7 (39%)
- E2E tests: 3 (17%)
- Priority distribution: P0: 6, P1: 8, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: libcluster configured for automatic node discovery and clustering

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- | ------------- |
| 1.3-UNIT-001 | Unit        | P1       | Validate libcluster config     | Pure configuration validation    | OPS-001       |
| 1.3-INT-001  | Integration | P0       | Node discovery within cluster  | Multi-node discovery flow        | TECH-001, OPS-001 |
| 1.3-E2E-001  | E2E         | P0       | Cluster formation (2+ nodes)   | Critical distributed functionality | TECH-001, OPS-001 |

### AC2: GenServer-based node management with supervision trees for fault tolerance

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- | ------------- |
| 1.3-UNIT-002 | Unit        | P0       | NodeManager GenServer state    | Core business logic              | TECH-002      |
| 1.3-UNIT-003 | Unit        | P1       | Supervision tree configuration | Supervisor setup validation      | TECH-002      |
| 1.3-INT-002  | Integration | P0       | GenServer failure recovery     | Supervision tree resilience      | TECH-002      |
| 1.3-INT-003  | Integration | P1       | Multiple GenServer interaction | Component communication          | TECH-002      |

### AC3: Phoenix Channels implemented for real-time node-to-node messaging

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- | ------------- |
| 1.3-UNIT-004 | Unit        | P1       | Channel message validation     | Message format verification      | SEC-001       |
| 1.3-INT-004  | Integration | P0       | Channel authentication         | Security integration             | SEC-001       |
| 1.3-INT-005  | Integration | P1       | PubSub message broadcasting    | Multi-component messaging        | PERF-002      |
| 1.3-E2E-002  | E2E         | P1       | Real-time messaging flow       | End-to-end communication        | PERF-002      |

### AC4: Basic node status tracking (online, offline, connecting) across the network

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- | ------------- |
| 1.3-UNIT-005 | Unit        | P1       | Status state transitions       | State machine logic              | DATA-001      |
| 1.3-INT-006  | Integration | P1       | Status propagation via PubSub  | Cross-node status updates        | DATA-001      |

### AC5: Connection health monitoring and automatic reconnection logic

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- | ------------- |
| 1.3-UNIT-006 | Unit        | P1       | Heartbeat generation logic     | Core heartbeat algorithm         | PERF-002      |
| 1.3-UNIT-007 | Unit        | P2       | Exponential backoff algorithm  | Reconnection timing logic        | -             |
| 1.3-INT-007  | Integration | P0       | Automatic reconnection flow    | Multi-component recovery         | TECH-001      |

### AC6: Network topology tracking showing which nodes are connected to which

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- | ------------- |
| 1.3-UNIT-008 | Unit        | P2       | Topology data structure        | Core data structure operations   | DATA-001      |
| 1.3-E2E-003  | E2E         | P2       | Topology accuracy validation   | End-to-end topology correctness  | DATA-001      |

### AC7: Support for 3-5 concurrent nodes with stable connections

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- | ------------- |
| 1.3-INT-008  | Integration | P2       | Multi-node load testing        | Performance under concurrent load | PERF-001, BUS-001 |

## Risk Coverage Analysis

### High Risk Coverage (Must Test)
- **TECH-001 (Split-brain)**: Covered by 1.3-INT-001, 1.3-E2E-001, 1.3-INT-007
- **TECH-002 (Cascade failures)**: Covered by 1.3-UNIT-002, 1.3-UNIT-003, 1.3-INT-002, 1.3-INT-003  
- **OPS-001 (EPMD failures)**: Covered by 1.3-UNIT-001, 1.3-INT-001, 1.3-E2E-001

### Medium Risk Coverage
- **PERF-001 (Gossip flooding)**: Covered by 1.3-INT-008
- **PERF-002 (Message storms)**: Covered by 1.3-UNIT-006, 1.3-INT-005, 1.3-E2E-002
- **DATA-001 (State consistency)**: Covered by 1.3-UNIT-005, 1.3-INT-006, 1.3-UNIT-008, 1.3-E2E-003

### Low Risk Coverage
- **SEC-001 (Auth bypass)**: Covered by 1.3-UNIT-004, 1.3-INT-004
- **BUS-001 (Scalability)**: Covered by 1.3-INT-008

## Test Implementation Details

### Unit Tests (8 scenarios)

**Location**: `apps/xpando_node/test/xpando_node/`

1. **1.3-UNIT-001**: Validate libcluster configuration parsing and defaults
2. **1.3-UNIT-002**: Test NodeManager GenServer state management and callbacks  
3. **1.3-UNIT-003**: Verify supervision tree child specifications
4. **1.3-UNIT-004**: Validate Phoenix Channel message formats and validation
5. **1.3-UNIT-005**: Test node status state machine transitions
6. **1.3-UNIT-006**: Verify heartbeat timing and generation logic
7. **1.3-UNIT-007**: Test exponential backoff algorithm correctness
8. **1.3-UNIT-008**: Validate network topology data structure operations

### Integration Tests (7 scenarios)

**Location**: `apps/xpando_node/test/integration/`

1. **1.3-INT-001**: Multi-component node discovery with libcluster + NodeManager
2. **1.3-INT-002**: GenServer failure and supervision tree recovery testing
3. **1.3-INT-003**: NodeManager interaction with other GenServers
4. **1.3-INT-004**: Phoenix Channel authentication with existing Token system
5. **1.3-INT-005**: PubSub message broadcasting across multiple subscribers
6. **1.3-INT-006**: Node status updates propagating via PubSub
7. **1.3-INT-007**: Complete automatic reconnection with health monitoring
8. **1.3-INT-008**: Performance testing with 3-5 concurrent nodes

### E2E Tests (3 scenarios)

**Location**: `apps/xpando_web/test/e2e/`

1. **1.3-E2E-001**: Complete cluster formation with multiple actual nodes
2. **1.3-E2E-002**: End-to-end real-time messaging between distributed nodes
3. **1.3-E2E-003**: Network topology accuracy across distributed system

## Risk-Based Testing Execution Order

### Phase 1: Critical Risk Mitigation (P0 tests)
1. **1.3-INT-001**: Node discovery functionality (TECH-001, OPS-001)
2. **1.3-UNIT-002**: NodeManager core logic (TECH-002)
3. **1.3-INT-002**: Supervision tree resilience (TECH-002)
4. **1.3-INT-004**: Channel authentication security (SEC-001)
5. **1.3-INT-007**: Reconnection logic (TECH-001)
6. **1.3-E2E-001**: Cluster formation validation (TECH-001, OPS-001)

### Phase 2: Important Functionality (P1 tests)
7. **1.3-UNIT-001**: Configuration validation (OPS-001)
8. **1.3-UNIT-003**: Supervision setup (TECH-002)
9. **1.3-UNIT-004**: Message validation (SEC-001)
10. **1.3-UNIT-005**: Status transitions (DATA-001)
11. **1.3-UNIT-006**: Heartbeat logic (PERF-002)
12. **1.3-INT-003**: GenServer interactions (TECH-002)
13. **1.3-INT-005**: PubSub broadcasting (PERF-002)
14. **1.3-INT-006**: Status propagation (DATA-001)
15. **1.3-E2E-002**: Real-time messaging (PERF-002)

### Phase 3: Supporting Features (P2 tests)
16. **1.3-UNIT-007**: Backoff algorithm
17. **1.3-UNIT-008**: Topology data structures (DATA-001)
18. **1.3-E2E-003**: Topology accuracy (DATA-001)
19. **1.3-INT-008**: Load testing (PERF-001, BUS-001)

## Test Environment Requirements

### Unit Test Environment
- Standard ExUnit setup
- Mock dependencies for external services
- Isolated test processes

### Integration Test Environment  
- Local distributed Elixir nodes
- PostgreSQL test database
- Phoenix PubSub configured
- libcluster test topology

### E2E Test Environment
- Multi-node Docker setup or distributed test cluster
- Network simulation capabilities
- Real database connections
- Complete application stack

## Success Criteria

### Minimum Viable Testing
- All P0 tests must pass
- At least 80% of P1 tests pass
- Risk mitigation tests validate expected behavior

### Production Readiness
- All P0 and P1 tests pass consistently
- P2 tests pass or have documented acceptable failures
- Performance tests meet 3-5 node requirements
- All high-risk scenarios have automated validation

## Coverage Validation

✅ Every AC has test coverage  
✅ Test levels appropriate (unit for logic, integration for components, E2E for journeys)
✅ No duplicate coverage across levels  
✅ Priorities align with risk assessment
✅ Test IDs follow naming convention
✅ Risk-based execution order prioritizes critical paths